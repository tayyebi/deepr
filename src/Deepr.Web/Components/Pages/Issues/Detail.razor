@page "/issues/{Id:guid}"
@rendermode InteractiveServer
@inject DeeprApiClient Api
@inject NavigationManager Nav
@using Deepr.Web.Models
<PageTitle>@(_issue?.Title ?? "Issue") ‚Äî Deepr</PageTitle>

@if (_loading)
{
    <p><em>Loading...</em></p>
}
else if (_issue is null)
{
    <div class="alert alert-warning">Issue not found.</div>
}
else
{
    <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/">Issues</a></li>
            <li class="breadcrumb-item active">@_issue.Title</li>
        </ol>
    </nav>

    <div class="d-flex justify-content-between align-items-start mb-3">
        <div>
            <h1>@_issue.Title</h1>
            <p class="text-muted">@_issue.ContextVector</p>
        </div>
    </div>

    @if (_template is not null && _template.Id != "blank")
    {
        <div class="alert alert-primary d-flex align-items-center gap-2 mb-3 py-2">
            <span style="font-size:1.3rem;">@_template.Icon</span>
            <div class="small">
                <strong>Template suggests:</strong>
                <span class="ms-1 badge bg-primary">@IssueTemplates.MethodName(_template.RecommendedMethod)</span>
                <span class="ms-1 badge bg-secondary">@IssueTemplates.ToolName(_template.RecommendedTool)</span>
                @if (_template.RecommendedAgents.Count > 0)
                {
                    <span class="ms-1 badge bg-success">@_template.RecommendedAgents.Count recommended agents</span>
                }
                <span class="ms-2 text-muted">‚Äî create the council below to continue.</span>
            </div>
        </div>
    }

    <hr />

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4>Councils</h4>
        <button class="btn btn-primary" @onclick="() => _showCreateCouncil = true">+ New Council</button>
    </div>

    @if (_showCreateCouncil)
    {
        <div class="card mb-4 border-primary">
            <div class="card-header bg-primary text-white">Create Council</div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label fw-semibold">Decision Method</label>
                        <select class="form-select" @bind="_councilForm.Method" @bind:after="OnMethodChanged">
                            <optgroup label="‚îÄ‚îÄ Group-Based ‚îÄ‚îÄ">
                                <option value="2">Brainstorming (1 round ‚Äî free-form)</option>
                                <option value="4">Consensus Building (2 rounds)</option>
                                <option value="12">Majority Voting (2 rounds)</option>
                                <option value="1">NGT ‚Äî Nominal Group Technique (4 rounds)</option>
                                <option value="0">Delphi (3 rounds ‚Äî anonymous iteration)</option>
                            </optgroup>
                            <optgroup label="‚îÄ‚îÄ Analytical / Structured ‚îÄ‚îÄ">
                                <option value="6">Weighted Deliberation ‚Äî Discussion + Vote + Matrix (4 rounds)</option>
                                <option value="13">Six Thinking Hats (6 rounds ‚Äî de Bono)</option>
                                <option value="14">Cost‚ÄìBenefit Analysis (3 rounds)</option>
                                <option value="15">RAPID ‚Äî Recommend ¬∑ Agree ¬∑ Perform ¬∑ Input ¬∑ Decide (4 rounds)</option>
                                <option value="16">OODA Loop ‚Äî Observe ¬∑ Orient ¬∑ Decide ¬∑ Act (4 rounds)</option>
                            </optgroup>
                            <optgroup label="‚îÄ‚îÄ Change Management ‚îÄ‚îÄ">
                                <option value="5">ADKAR ‚Äî Awareness ¬∑ Desire ¬∑ Knowledge ¬∑ Ability ¬∑ Reinforcement (5 rounds)</option>
                            </optgroup>
                            <optgroup label="‚îÄ‚îÄ MCDA Methods (feeds MCDA Analysis tab) ‚îÄ‚îÄ">
                                <option value="7">AHP ‚Äî Analytic Hierarchy Process (Saaty 1‚Äì9)</option>
                                <option value="8">ELECTRE ‚Äî Concordance/Discordance Outranking</option>
                                <option value="9">TOPSIS ‚Äî Closeness to Ideal Solution</option>
                                <option value="10">PROMETHEE II ‚Äî Net Outranking Flow</option>
                                <option value="11">Grey Theory ‚Äî Grey Relational Analysis</option>
                            </optgroup>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-semibold">Analytical Tool</label>
                        <select class="form-select" @bind="_councilForm.Tool">
                            <option value="0">SWOT Analysis ‚Äî Strengths, Weaknesses, Opportunities, Threats</option>
                            <option value="2">Weighted Scoring ‚Äî criteria-based numeric scoring</option>
                            <option value="5">PESTLE Analysis ‚Äî Political, Economic, Social, Tech, Legal, Environmental</option>
                        </select>
                    </div>
                </div>

                @if (_activeMethodGuide is not null)
                {
                    <div class="card mt-3 border-0 bg-light">
                        <div class="card-body py-2 px-3">
                            <div class="d-flex align-items-center gap-2 mb-1">
                                <span style="font-size:1.3rem;">@_activeMethodGuide.Emoji</span>
                                <div>
                                    <strong class="small">@_activeMethodGuide.Name</strong>
                                    <span class="badge bg-secondary ms-1" style="font-size:.65rem;">@_activeMethodGuide.Category</span>
                                    <span class="badge bg-primary ms-1" style="font-size:.65rem;">@_activeMethodGuide.Rounds round(s)</span>
                                </div>
                            </div>
                            <p class="small text-muted mb-1"><em>@_activeMethodGuide.Tagline</em></p>
                            <p class="small mb-2">@_activeMethodGuide.Description</p>
                            <div class="row g-2 mb-2">
                                <div class="col-md-6">
                                    <div class="small fw-semibold text-success">‚úÖ Best for</div>
                                    <div class="small text-muted">@_activeMethodGuide.BestFor</div>
                                </div>
                                <div class="col-md-6">
                                    <div class="small fw-semibold text-danger">‚ö†Ô∏è Not ideal for</div>
                                    <div class="small text-muted">@_activeMethodGuide.NotSuitableFor</div>
                                </div>
                            </div>
                            @if (_activeMethodGuide.Tips.Length > 0)
                            {
                                <details class="small">
                                    <summary class="text-muted" style="cursor:pointer;">üí° Tips &amp; guidance (@_activeMethodGuide.Tips.Length)</summary>
                                    <ul class="mb-0 mt-1 ps-3">
                                        @foreach (var tip in _activeMethodGuide.Tips)
                                        {
                                            <li>@tip</li>
                                        }
                                    </ul>
                                </details>
                            }
                            <div class="mt-2 small text-muted">
                                <strong>Rounds:</strong> @_activeMethodGuide.RoundsSummary
                            </div>
                        </div>
                    </div>
                }

                @if (_councilError is not null)
                {
                    <div class="alert alert-danger mt-3">@_councilError</div>
                }
                <div class="d-flex gap-2 mt-3">
                    <button class="btn btn-primary" @onclick="CreateCouncil" disabled="@_savingCouncil">
                        @(_savingCouncil ? "Creating..." : "Create Council")
                    </button>
                    <button class="btn btn-outline-secondary" @onclick="() => _showCreateCouncil = false">Cancel</button>
                </div>
            </div>
        </div>
    }

    @if (_councils.Any())
    {
        <div class="list-group">
            @foreach (var council in _councils)
            {
                <a href="councils/@council.Id" class="list-group-item list-group-item-action">
                    <div class="d-flex justify-content-between">
                        <div>
                            <span class="badge bg-primary me-2">@MethodName(council.SelectedMethod)</span>
                            <span class="badge bg-secondary me-2">@ToolName(council.SelectedTool)</span>
                            <span class="text-muted small">@council.Agents.Count member(s)</span>
                        </div>
                        <small class="text-muted">@council.CreatedAt.ToString("MMM d, yyyy")</small>
                    </div>
                </a>
            }
        </div>
    }
    else if (!_showCreateCouncil)
    {
        <div class="alert alert-light">No councils yet. Create one to start a decision session.</div>
    }
}

@if (_error is not null)
{
    <div class="alert alert-danger mt-3">@_error</div>
}

@code {
    [Parameter] public Guid Id { get; set; }

    [SupplyParameterFromQuery(Name = "templateId")]
    public string? TemplateId { get; set; }

    private IssueDto? _issue;
    private List<CouncilDto> _councils = new();
    private bool _loading = true;
    private string? _error;

    private bool _showCreateCouncil;
    private bool _savingCouncil;
    private string? _councilError;
    private CouncilForm _councilForm = new();

    private IssueTemplate? _template;
    private MethodGuide? _activeMethodGuide;
    private string? _appliedTemplateId = "~unset~";

    protected override async Task OnInitializedAsync()
    {
        try
        {
            _issue = await Api.GetIssueAsync(Id);
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _loading = false;
        }
    }

    protected override void OnParametersSet()
    {
        if (_appliedTemplateId == TemplateId) return;
        _appliedTemplateId = TemplateId;

        if (!string.IsNullOrEmpty(TemplateId))
        {
            _template = IssueTemplates.FindById(TemplateId);
            if (_template is not null && _template.Id != "blank")
            {
                _councilForm.Method = _template.RecommendedMethod;
                _councilForm.Tool = _template.RecommendedTool;
                _showCreateCouncil = true;
            }
        }
        _activeMethodGuide = DecisionMethodGuides.FindById(_councilForm.Method);
    }

    private void OnMethodChanged()
    {
        _activeMethodGuide = DecisionMethodGuides.FindById(_councilForm.Method);
    }

    private async Task CreateCouncil()
    {
        _savingCouncil = true;
        _councilError = null;
        try
        {
            var council = await Api.CreateCouncilAsync(Id, _councilForm.Method, _councilForm.Tool);
            if (council is not null)
            {
                _councils.Add(council);
                _showCreateCouncil = false;
                var dest = string.IsNullOrEmpty(TemplateId)
                    ? $"/councils/{council.Id}"
                    : $"/councils/{council.Id}?templateId={Uri.EscapeDataString(TemplateId)}";
                Nav.NavigateTo(dest);
            }
        }
        catch (Exception ex)
        {
            _councilError = ex.Message;
        }
        finally
        {
            _savingCouncil = false;
        }
    }

    private static string MethodName(int m) => m switch
    {
        0 => "Delphi",
        1 => "NGT",
        2 => "Brainstorming",
        4 => "Consensus",
        5 => "ADKAR",
        6 => "Weighted Deliberation",
        7 => "AHP",
        8 => "ELECTRE",
        9 => "TOPSIS",
        10 => "PROMETHEE II",
        11 => "Grey Theory",
        _ => $"Method {m}"
    };

    private static string ToolName(int t) => t switch
    {
        0 => "SWOT",
        2 => "Weighted Scoring",
        5 => "PESTLE",
        _ => $"Tool {t}"
    };

    private class CouncilForm
    {
        public int Method { get; set; } = 2;
        public int Tool { get; set; } = 0;
    }
}

