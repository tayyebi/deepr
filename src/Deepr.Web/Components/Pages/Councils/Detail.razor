@page "/councils/{Id:guid}"
@rendermode InteractiveServer
@inject DeeprApiClient Api
@inject NavigationManager Nav
@inject IJSRuntime JS
@using Deepr.Web.Models

<PageTitle>Council ‚Äî Deepr</PageTitle>

@if (_loading)
{
    <p><em>Loading...</em></p>
}
else if (_council is null)
{
    <div class="alert alert-warning">Council not found.</div>
}
else
{
    <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/">Issues</a></li>
            <li class="breadcrumb-item"><a href="issues/@_council.IssueId">Issue</a></li>
            <li class="breadcrumb-item active">Council</li>
        </ol>
    </nav>

    <div class="mb-3">
        <h2>Council</h2>
        <p>
            <span class="badge bg-primary me-1">@MethodName(_council.SelectedMethod)</span>
            <span class="badge bg-secondary me-1">@ToolName(_council.SelectedTool)</span>
        </p>
    </div>

    <div class="row g-4">
        <!-- Members panel -->
        <div class="col-md-5">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <strong>Members (@_council.Agents.Count)</strong>
                    <button class="btn btn-sm btn-outline-primary" @onclick="() => _showAddMember = !_showAddMember">
                        @(_showAddMember ? "Cancel" : "+ Add Member")
                    </button>
                </div>
                @if (_showAddMember)
                {
                    <div class="card-body border-bottom">
                        <div class="mb-2">
                            <label class="form-label small fw-semibold">Name</label>
                            <InputText @bind-Value="_memberForm.Name" class="form-control form-control-sm" placeholder="e.g. Dr. Sarah Chen" />
                        </div>
                        <div class="mb-2">
                            <label class="form-label small fw-semibold">Role</label>
                            <select class="form-select form-select-sm" @bind="_memberForm.Role">
                                <option value="0">Moderator / Chairman ‚Äî frames discussion</option>
                                <option value="1" selected>Expert ‚Äî discusses &amp; votes</option>
                                <option value="2">Critic ‚Äî challenges &amp; votes</option>
                                <option value="3">Observer ‚Äî watch-only (silent)</option>
                            </select>
                        </div>
                        <div class="mb-2">
                            <div class="form-check">
                                <InputCheckbox @bind-Value="_memberForm.IsAi" class="form-check-input" id="isAiCheck" />
                                <label class="form-check-label" for="isAiCheck">AI Agent</label>
                            </div>
                        </div>
                        @if (_memberForm.IsAi)
                        {
                            <div class="mb-2">
                                <label class="form-label small fw-semibold">
                                    Custom AI Persona Prompt
                                    <span class="text-muted fw-normal">(optional)</span>
                                </label>
                                <textarea @bind="_memberForm.SystemPromptOverride"
                                          class="form-control form-control-sm" rows="3"
                                          placeholder="e.g. You are Dr. Sarah Chen, a digital transformation expert with 15 years experience. You are pragmatic and data-driven."></textarea>
                            </div>
                        }
                        @if (_memberError is not null)
                        {
                            <div class="alert alert-danger py-1 small">@_memberError</div>
                        }
                        <button class="btn btn-sm btn-primary" @onclick="AddMember" disabled="@_savingMember">
                            @(_savingMember ? "Adding..." : "Add")
                        </button>
                    </div>
                }
                <ul class="list-group list-group-flush">
                    @if (!_council.Agents.Any())
                    {
                        <li class="list-group-item text-muted small">No members yet</li>
                    }
                    @foreach (var agent in _council.Agents)
                    {
                        <li class="list-group-item">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>@agent.Name</strong>
                                    <span class="badge @RoleBadgeClass(agent.Role) ms-1">@RoleName(agent.Role)</span>
                                    @if (!string.IsNullOrWhiteSpace(agent.SystemPromptOverride))
                                    {
                                        <span class="badge bg-light text-secondary border ms-1" title="@agent.SystemPromptOverride">üß† custom prompt</span>
                                    }
                                </div>
                                <span class="text-muted small">@(agent.IsAi ? "ü§ñ AI" : "üë§ Human")</span>
                            </div>
                        </li>
                    }
                </ul>
                @if (_suggestedAgents.Count > 0)
                {
                    <div class="card-body border-top pt-2 pb-1">
                        <p class="small fw-semibold text-muted mb-2">‚ú® Template suggestions ‚Äî click to add:</p>
                        @foreach (var suggested in _suggestedAgents)
                        {
                            var alreadyAdded = _council.Agents.Any(a => a.Name == suggested.Name);
                            <div class="d-flex align-items-center justify-content-between mb-1">
                                <div class="small">
                                    <span class="badge @RoleBadgeClass(suggested.Role) me-1">@RoleName(suggested.Role)</span>
                                    <span>@suggested.Name</span>
                                    @if (!string.IsNullOrWhiteSpace(suggested.SystemPromptOverride))
                                    {
                                        <span class="badge bg-light text-secondary border ms-1" title="@suggested.SystemPromptOverride">üß†</span>
                                    }
                                    <span class="ms-1 text-muted">@(suggested.IsAi ? "ü§ñ" : "üë§")</span>
                                    @if (!string.IsNullOrEmpty(suggested.ModelHint))
                                    {
                                        <span class="badge bg-info-subtle text-info-emphasis border border-info-subtle ms-1" style="font-size:.65rem;" title="Preferred AI model">‚ö° @suggested.ModelHint</span>
                                    }
                                    @if (suggested.MaxTokens.HasValue)
                                    {
                                        <span class="badge bg-warning-subtle text-warning-emphasis border border-warning-subtle ms-1" style="font-size:.65rem;" title="Max tokens">üî¢ @suggested.MaxTokens</span>
                                    }
                                    @if (suggested.KnowledgeDocuments.Count > 0)
                                    {
                                        <span class="badge bg-success-subtle text-success-emphasis border border-success-subtle ms-1"
                                              style="font-size:.65rem;"
                                              title="@string.Join("\n", suggested.KnowledgeDocuments.Select(d => d.FileName))">
                                            üìÑ @suggested.KnowledgeDocuments.Count doc(s)
                                        </span>
                                    }
                                </div>
                                <button class="btn btn-sm @(alreadyAdded ? "btn-outline-secondary" : "btn-outline-primary") py-0"
                                        disabled="@(alreadyAdded || _savingMember)"
                                        @onclick="() => AddSuggestedMember(suggested)">
                                    @(alreadyAdded ? "‚úì" : "+ Add")
                                </button>
                            </div>
                        }
                    </div>
                }
            </div>
        </div>

        <!-- Session panel -->
        <div class="col-md-7">
            <div class="card">
                <div class="card-header"><strong>Session</strong></div>
                <div class="card-body">
                    @if (_session is null)
                    {
                        <p class="text-muted">No active session.</p>
                        @if (_sessionError is not null)
                        {
                            <div class="alert alert-danger small">@_sessionError</div>
                        }
                        <button class="btn btn-success" @onclick="StartSession"
                            disabled="@(_startingSession || !_council.Agents.Any())">
                            @(_startingSession ? "Starting..." : "‚ñ∂ Start Session")
                        </button>
                        @if (!_council.Agents.Any())
                        {
                            <p class="text-muted small mt-2">Add at least one member to start a session.</p>
                        }
                    }
                    else
                    {
                        <div class="mb-3">
                            <span class="badge @StatusBadgeClass(_session.Status) me-2">@StatusName(_session.Status)</span>
                            <span class="text-muted small">Round @_session.CurrentRoundNumber</span>
                        </div>

                        @if (_rounds.Any())
                        {
                            @foreach (var round in _rounds.OrderBy(r => r.RoundNumber))
                            {
                                <div class="card mb-2 border-light">
                                    <div class="card-header py-1 bg-light small">
                                        <strong>Round @round.RoundNumber</strong>
                                    </div>
                                    <div class="card-body py-2">
                                        @if (round.Summary is not null)
                                        {
                                            <p class="small mb-2" style="white-space:pre-wrap">@round.Summary</p>
                                        }
                                        @foreach (var c in round.Contributions)
                                        {
                                            <div class="border-start border-3 ps-2 mb-1 small">
                                                <span class="text-muted">Agent @c.AgentId.ToString()[..8]‚Ä¶</span>
                                                <p class="mb-0">@c.RawContent</p>
                                            </div>
                                        }
                                    </div>
                                </div>
                            }
                        }

                        @if (_finalResult is not null)
                        {
                            <div class="alert alert-success">
                                <strong>Final Result:</strong>
                                <pre class="mb-0 mt-1 small" style="white-space:pre-wrap">@_finalResult</pre>
                            </div>
                        }

                        @if (_matrix is not null)
                        {
                            <div class="card mt-3 border-success">
                                <div class="card-header bg-success text-white py-1 small">
                                    <strong>üìä Decision Matrix Results</strong>
                                </div>
                                <div class="card-body p-2">
                                    <div class="table-responsive">
                                        <table class="table table-sm table-bordered small mb-2">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>Option</th>
                                                    @foreach (var c in _matrix.Criteria)
                                                    {
                                                        <th class="text-center">
                                                            @c.Name<br />
                                                            <small class="text-muted">@c.Weight.ToString("P0")</small>
                                                        </th>
                                                    }
                                                    <th class="text-center fw-bold">Score</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                @foreach (var opt in _matrix.Ranking)
                                                {
                                                    var isTop = opt == _matrix.Ranking.FirstOrDefault();
                                                    <tr class="@(isTop ? "table-success" : "")">
                                                        <td class="fw-semibold">
                                                            @if (isTop) { <span>‚úÖ </span> }@opt
                                                        </td>
                                                        @foreach (var c in _matrix.Criteria)
                                                        {
                                                            var score = _matrix.AverageScores.TryGetValue(opt, out var os) && os.TryGetValue(c.Name, out var s) ? s : 5.0;
                                                            <td class="text-center">@score.ToString("F1")</td>
                                                        }
                                                        <td class="text-center fw-bold text-success">
                                                            @(_matrix.WeightedScores.TryGetValue(opt, out var ws) ? ws.ToString("F2") : "‚Äî")
                                                        </td>
                                                    </tr>
                                                }
                                            </tbody>
                                        </table>
                                    </div>
                                    <div class="small">
                                        <strong>Ranking:</strong>
                                        <ol class="mb-0">
                                            @for (int i = 0; i < _matrix.Ranking.Count; i++)
                                            {
                                                var opt = _matrix.Ranking[i];
                                                var score = _matrix.WeightedScores.TryGetValue(opt, out var w) ? w.ToString("F2") : "‚Äî";
                                                <li>@opt ‚Äî @score @(i == 0 ? "‚úÖ" : "")</li>
                                            }
                                        </ol>
                                    </div>
                                </div>
                            </div>
                        }

                        @if (_roundError is not null)
                        {
                            <div class="alert alert-danger small">@_roundError</div>
                        }

                        @if (_exportError is not null)
                        {
                            <div class="alert alert-danger small">@_exportError</div>
                        }

                        <div class="d-flex gap-2 mt-2">
                            @if (_session.Status == 0)
                            {
                                <button class="btn btn-primary" @onclick="ExecuteRound" disabled="@_executingRound">
                                    @(_executingRound ? "Running..." : "‚ö° Execute Next Round")
                                </button>
                                <button class="btn btn-outline-secondary" @onclick="FinalizeSession" disabled="@_finalizing">
                                    @(_finalizing ? "Finalizing..." : "‚úÖ Finalize")
                                </button>
                            }
                            @if (_session.Status == 2 || _rounds.Any())
                            {
                                <button class="btn btn-outline-success" @onclick="ExportDecisionSheet" disabled="@_exporting">
                                    @(_exporting ? "Exporting..." : "üì• Export Decision Sheet")
                                </button>
                            }
                        </div>

                        @* ‚îÄ‚îÄ Step 8: MCDA Analysis ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ *@
                        @if (_mcdaBridge is not null)
                        {
                            <div class="card mt-4 border-primary">
                                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                                    <span><strong>üìä Step 8 ‚Äî MCDA Analysis</strong></span>
                                    <button class="btn btn-sm @(_mcdaEditing ? "btn-warning" : "btn-light")"
                                            @onclick="@(() => { _mcdaEditing = !_mcdaEditing; _mcdaResult = null; _mcdaError = null; })">
                                        @(_mcdaEditing ? "üîí Lock" : "üîì Enable Editing")
                                    </button>
                                </div>
                                <div class="card-body">

                                    @* 8.1 Method *@
                                    <div class="mb-3">
                                        <label class="form-label small fw-semibold text-muted">8.1 ¬∑ Method</label>
                                        <select class="form-select form-select-sm" disabled="@(!_mcdaEditing)"
                                                value="@_mcdaBridge.McdaMethod"
                                                @onchange="@(e => SetMcdaMethod(e.Value?.ToString()))">
                                            <option value="ahp">AHP ‚Äî Analytic Hierarchy Process</option>
                                            <option value="electre">ELECTRE ‚Äî Concordance/Discordance</option>
                                            <option value="topsis">TOPSIS ‚Äî Closeness to Ideal</option>
                                            <option value="promethee">PROMETHEE II ‚Äî Net Flow</option>
                                            <option value="grey-theory">Grey Theory ‚Äî GRA</option>
                                        </select>
                                    </div>

                                    @* 8.2 Options *@
                                    <div class="mb-3">
                                        <label class="form-label small fw-semibold text-muted">8.2 ¬∑ Options</label>
                                        @for (int i = 0; i < _mcdaBridge.Options.Count; i++)
                                        {
                                            int idx = i;
                                            <div class="input-group input-group-sm mb-1">
                                                <span class="input-group-text">@(idx + 1)</span>
                                                <input type="text" class="form-control" value="@_mcdaBridge.Options[idx]"
                                                       disabled="@(!_mcdaEditing)"
                                                       @onchange="@(e => _mcdaBridge.Options[idx] = e.Value?.ToString() ?? string.Empty)" />
                                                @if (_mcdaEditing)
                                                {
                                                    <button class="btn btn-outline-danger" type="button"
                                                            @onclick="@(() => { if (_mcdaBridge.Options.Count > 2) _mcdaBridge.Options.RemoveAt(idx); })">‚úï</button>
                                                }
                                            </div>
                                        }
                                        @if (_mcdaEditing)
                                        {
                                            <button class="btn btn-sm btn-outline-primary mt-1"
                                                    @onclick="@(() => _mcdaBridge.Options.Add("New Option"))">+ Add Option</button>
                                        }
                                    </div>

                                    @* 8.3 Criteria & Weights *@
                                    <div class="mb-3">
                                        <label class="form-label small fw-semibold text-muted">8.3 ¬∑ Criteria &amp; Weights</label>
                                        <div class="row gx-1 mb-1 text-muted small fw-semibold">
                                            <div class="col-5">Name</div>
                                            <div class="col-3">Weight</div>
                                            @if (_mcdaBridge.McdaMethod == "topsis")
                                            {
                                                <div class="col-3">Type</div>
                                            }
                                        </div>
                                        @for (int i = 0; i < _mcdaBridge.Criteria.Count; i++)
                                        {
                                            int idx = i;
                                            <div class="row gx-1 mb-1 align-items-center">
                                                <div class="col-5">
                                                    <input type="text" class="form-control form-control-sm"
                                                           value="@_mcdaBridge.Criteria[idx].Name"
                                                           disabled="@(!_mcdaEditing)"
                                                           @onchange="@(e => _mcdaBridge.Criteria[idx].Name = e.Value?.ToString() ?? string.Empty)" />
                                                </div>
                                                <div class="col-3">
                                                    <input type="number" class="form-control form-control-sm" min="0.01" step="0.1"
                                                           value="@_mcdaBridge.Criteria[idx].Weight"
                                                           disabled="@(!_mcdaEditing)"
                                                           @onchange="@(e => SetMcdaCriterionWeight(idx, e.Value?.ToString()))" />
                                                </div>
                                                @if (_mcdaBridge.McdaMethod == "topsis")
                                                {
                                                    <div class="col-3">
                                                        <select class="form-select form-select-sm" disabled="@(!_mcdaEditing)"
                                                                value="@(_mcdaBridge.Criteria[idx].IsBenefit ? "benefit" : "cost")"
                                                                @onchange="@(e => _mcdaBridge.Criteria[idx].IsBenefit = e.Value?.ToString() != "cost")">
                                                            <option value="benefit">Benefit ‚Üë</option>
                                                            <option value="cost">Cost ‚Üì</option>
                                                        </select>
                                                    </div>
                                                }
                                                @if (_mcdaEditing)
                                                {
                                                    <div class="col-1">
                                                        <button class="btn btn-sm btn-outline-danger"
                                                                @onclick="@(() => { if (_mcdaBridge.Criteria.Count > 1) _mcdaBridge.Criteria.RemoveAt(idx); })">‚úï</button>
                                                    </div>
                                                }
                                            </div>
                                        }
                                        @if (_mcdaEditing)
                                        {
                                            <button class="btn btn-sm btn-outline-primary mt-1"
                                                    @onclick="@(() => _mcdaBridge.Criteria.Add(new McdaCriterionModel { Name = "New Criterion", Weight = 1.0, IsBenefit = true }))">+ Add Criterion</button>
                                        }
                                    </div>

                                    @* 8.4 Score Matrix *@
                                    <div class="mb-3">
                                        <label class="form-label small fw-semibold text-muted">
                                            8.4 ¬∑ Score Matrix
                                            <span class="fw-normal">@(_mcdaBridge.McdaMethod == "ahp" ? "(1‚Äì9 Saaty)" : "(0‚Äì10)")</span>
                                        </label>
                                        <div style="overflow-x:auto;">
                                            <table class="table table-sm table-bordered align-middle mb-0">
                                                <thead class="table-light">
                                                    <tr>
                                                        <th>Option</th>
                                                        @foreach (var c in _mcdaBridge.Criteria)
                                                        {
                                                            <th class="text-center small">@(string.IsNullOrWhiteSpace(c.Name) ? "‚Äî" : c.Name)</th>
                                                        }
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    @foreach (var opt in _mcdaBridge.Options)
                                                    {
                                                        <tr>
                                                            <td class="fw-semibold small text-nowrap">@opt</td>
                                                            @foreach (var c in _mcdaBridge.Criteria)
                                                            {
                                                                string o2 = opt; string cn = c.Name;
                                                                <td>
                                                                    <input type="number" class="form-control form-control-sm text-center"
                                                                           style="min-width:55px"
                                                                           min="@(_mcdaBridge.McdaMethod == "ahp" ? "1" : "0")"
                                                                           max="@(_mcdaBridge.McdaMethod == "ahp" ? "9" : "10")"
                                                                           step="0.5" disabled="@(!_mcdaEditing)"
                                                                           value="@GetBridgeScore(o2, cn)"
                                                                           @onchange="@(e => SetBridgeScore(o2, cn, e.Value?.ToString()))" />
                                                                </td>
                                                            }
                                                        </tr>
                                                    }
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>

                                    @if (_mcdaError is not null)
                                    {
                                        <div class="alert alert-danger small">@_mcdaError</div>
                                    }

                                    <button class="btn btn-primary" @onclick="RunMcda" disabled="@_mcdaRunning">
                                        @(_mcdaRunning ? "Computing‚Ä¶" : "‚ñ∂ Run MCDA Analysis")
                                    </button>

                                    @* Results *@
                                    @if (_mcdaRunning)
                                    {
                                        <div class="text-center py-3 text-muted">
                                            <div class="spinner-border spinner-border-sm text-primary me-2" role="status"></div>
                                            Computing‚Ä¶
                                        </div>
                                    }
                                    else if (_mcdaResult is not null)
                                    {
                                        <div class="card mt-3 border-success">
                                            <div class="card-header bg-success text-white py-1 small">
                                                <strong>üèÜ MCDA Ranking ‚Äî @_mcdaResult.Method.ToUpperInvariant()</strong>
                                            </div>
                                            <div class="card-body py-2">
                                                @for (int i = 0; i < _mcdaResult.Ranking.Count; i++)
                                                {
                                                    string rOpt = _mcdaResult.Ranking[i];
                                                    double rScore = _mcdaResult.Scores.TryGetValue(rOpt, out var rs) ? rs : 0;
                                                    string medal = i switch { 0 => "ü•á", 1 => "ü•à", 2 => "ü•â", _ => $"{i + 1}." };
                                                    double maxAbs = _mcdaResult.Scores.Values.Any() ? _mcdaResult.Scores.Values.Max(v => Math.Abs(v)) : 1;
                                                    string barW = (maxAbs > 0 ? Math.Abs(rScore) / maxAbs * 100 : 0).ToString("F1", System.Globalization.CultureInfo.InvariantCulture);
                                                    string barCls = i == 0 ? "bg-success" : (i == 1 ? "bg-info" : "bg-secondary");
                                                    <div class="mb-2">
                                                        <div class="d-flex justify-content-between align-items-center mb-1">
                                                            <span class="small fw-semibold">@medal @rOpt</span>
                                                            <span class="badge bg-primary">@rScore.ToString("F4")</span>
                                                        </div>
                                                        <div class="progress" style="height:6px">
                                                            <div class="progress-bar @barCls" style="width:@(barW)%"></div>
                                                        </div>
                                                    </div>
                                                }
                                                @if (!string.IsNullOrWhiteSpace(_mcdaResult.Summary))
                                                {
                                                    <details class="mt-2">
                                                        <summary class="small text-muted" style="cursor:pointer">üìã Show analysis detail</summary>
                                                        <pre class="mt-2 small" style="white-space:pre-wrap;font-size:.78rem">@_mcdaResult.Summary</pre>
                                                    </details>
                                                }
                                            </div>
                                        </div>
                                    }
                                </div>
                            </div>
                        }

                    }
                </div>
            </div>
        </div>
    </div>
}

@if (_error is not null)
{
    <div class="alert alert-danger mt-3">@_error</div>
}

@code {
    [Parameter] public Guid Id { get; set; }

    [SupplyParameterFromQuery(Name = "templateId")]
    public string? TemplateId { get; set; }

    private CouncilDto? _council;
    private SessionDto? _session;
    private List<SessionRoundDto> _rounds = new();
    private string? _finalResult;
    private bool _loading = true;
    private string? _error;

    private bool _showAddMember;
    private bool _savingMember;
    private string? _memberError;
    private MemberForm _memberForm = new();

    private List<TemplateAgent> _suggestedAgents = new();
    private string? _appliedTemplateId = "~unset~";

    private bool _startingSession;
    private string? _sessionError;

    private bool _executingRound;
    private bool _finalizing;
    private string? _roundError;

    private bool _exporting;
    private string? _exportError;

    private MatrixDisplay? _matrix;

    // ‚îÄ‚îÄ MCDA bridge (Step 8) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    private McdaBridgeState? _mcdaBridge;
    private bool _mcdaEditing;
    private bool _mcdaRunning;
    private string? _mcdaError;
    private McdaResultModel? _mcdaResult;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            _council = await Api.GetCouncilAsync(Id);
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _loading = false;
        }
    }

    protected override void OnParametersSet()
    {
        if (_appliedTemplateId == TemplateId) return;
        _appliedTemplateId = TemplateId;

        if (!string.IsNullOrEmpty(TemplateId))
        {
            var template = IssueTemplates.FindById(TemplateId);
            if (template is not null && template.RecommendedAgents.Count > 0)
                _suggestedAgents = template.RecommendedAgents.ToList();
        }
    }

    private async Task AddSuggestedMember(TemplateAgent agent)
    {
        if (_savingMember) return;
        _savingMember = true;
        _memberError = null;
        try
        {
            var agentId = Guid.NewGuid();
            // Append any knowledge documents to the system prompt so they are persisted with the agent
            var prompt = agent.SystemPromptOverride;
            if (agent.KnowledgeDocuments.Count > 0)
            {
                var docs = string.Join("\n\n", agent.KnowledgeDocuments.Select(d =>
                    $"--- {d.FileName} ---\n{d.Content}"));
                prompt = string.IsNullOrEmpty(prompt)
                    ? docs
                    : $"{prompt}\n\n## Knowledge Base\n{docs}";
            }
            _council = await Api.AddMemberAsync(Id, agentId, agent.Name, agent.Role, agent.IsAi, prompt);
        }
        catch (Exception ex)
        {
            _memberError = ex.Message;
        }
        finally
        {
            _savingMember = false;
        }
    }

    private async Task AddMember()
    {
        if (string.IsNullOrWhiteSpace(_memberForm.Name)) { _memberError = "Name is required."; return; }
        _savingMember = true;
        _memberError = null;
        try
        {
            var agentId = Guid.NewGuid();
            _council = await Api.AddMemberAsync(Id, agentId, _memberForm.Name, _memberForm.Role, _memberForm.IsAi, _memberForm.SystemPromptOverride);
            _memberForm = new();
            _showAddMember = false;
        }
        catch (Exception ex)
        {
            _memberError = ex.Message;
        }
        finally
        {
            _savingMember = false;
        }
    }

    private async Task StartSession()
    {
        _startingSession = true;
        _sessionError = null;
        try
        {
            _session = await Api.StartSessionAsync(Id);
            _rounds.Clear();
            _finalResult = null;
            _matrix = null;
            _mcdaBridge = null;
            _mcdaResult = null;
        }
        catch (Exception ex)
        {
            _sessionError = ex.Message;
        }
        finally
        {
            _startingSession = false;
        }
    }

    private async Task ExecuteRound()
    {
        if (_session is null) return;
        _executingRound = true;
        _roundError = null;
        try
        {
            var round = await Api.ExecuteRoundAsync(_session.Id);
            if (round is not null)
                _rounds.Add(round);
            _session = await Api.GetSessionAsync(_session.Id);
            RefreshMatrix();
            RefreshMcdaBridge();
        }
        catch (Exception ex)
        {
            _roundError = ex.Message;
        }
        finally
        {
            _executingRound = false;
        }
    }

    private async Task FinalizeSession()
    {
        if (_session is null) return;
        _finalizing = true;
        _roundError = null;
        try
        {
            _finalResult = await Api.FinalizeSessionAsync(_session.Id);
            _session = await Api.GetSessionAsync(_session.Id);
            RefreshMatrix();
            RefreshMcdaBridge();
        }
        catch (Exception ex)
        {
            _roundError = ex.Message;
        }
        finally
        {
            _finalizing = false;
        }
    }

    private async Task ExportDecisionSheet()
    {
        if (_session is null) return;
        _exporting = true;
        _exportError = null;
        try
        {
            var (content, fileName, contentType) = await Api.ExportDecisionSheetAsync(_session.Id);
            var base64 = Convert.ToBase64String(content);
            await JS.InvokeVoidAsync("deepr.downloadFile", fileName, base64, contentType);
        }
        catch (Exception ex)
        {
            _exportError = ex.Message;
        }
        finally
        {
            _exporting = false;
        }
    }

    private static string MethodName(int m) => m switch
    {
        0 => "Delphi", 1 => "NGT", 2 => "Brainstorming", 4 => "Consensus",
        5 => "ADKAR", 6 => "Weighted Deliberation",
        7 => "AHP", 8 => "ELECTRE", 9 => "TOPSIS", 10 => "PROMETHEE II", 11 => "Grey Theory",
        12 => "Majority Voting", 13 => "Six Thinking Hats",
        14 => "Cost‚ÄìBenefit Analysis", 15 => "RAPID", 16 => "OODA Loop",
        _ => $"Method {m}"
    };
    private static string ToolName(int t) => t switch { 0 => "SWOT", 2 => "Weighted Scoring", 5 => "PESTLE", _ => $"Tool {t}" };
    private static string RoleName(int r) => r switch { 0 => "Moderator", 1 => "Expert", 2 => "Critic", 3 => "Observer", _ => $"Role {r}" };
    private static string RoleBadgeClass(int r) => r switch { 0 => "bg-warning text-dark", 1 => "bg-info text-dark", 2 => "bg-danger", _ => "bg-secondary" };
    private static string StatusName(int s) => s switch { 0 => "Active", 1 => "Paused", 2 => "Completed", 3 => "Failed", _ => "Unknown" };
    private static string StatusBadgeClass(int s) => s switch { 0 => "bg-success", 1 => "bg-warning text-dark", 2 => "bg-primary", 3 => "bg-danger", _ => "bg-secondary" };

    private void RefreshMatrix()
    {
        _matrix = null;
        if (string.IsNullOrEmpty(_session?.StatePayload) || _session.StatePayload == "{}") return;
        try
        {
            using var doc = JsonDocument.Parse(_session.StatePayload);
            var root = doc.RootElement;
            if (!root.TryGetProperty("matrix", out var matrixEl) || matrixEl.ValueKind != JsonValueKind.Object) return;
            if (!matrixEl.TryGetProperty("ranking", out var rankEl)) return;
            if (!matrixEl.TryGetProperty("criteria", out var critEl)) return;
            if (!matrixEl.TryGetProperty("averageScores", out var avgEl)) return;
            if (!matrixEl.TryGetProperty("weightedScores", out var wsEl)) return;

            var md = new MatrixDisplay
            {
                Ranking = rankEl.EnumerateArray().Select(e => e.GetString() ?? "").Where(s => s.Length > 0).ToList(),
                Criteria = critEl.EnumerateArray()
                    .Select(c => (c.GetProperty("name").GetString() ?? "", c.GetProperty("weight").GetDouble()))
                    .Where(c => c.Item1.Length > 0).ToList()
            };

            foreach (var opt in md.Ranking)
            {
                md.AverageScores[opt] = new();
                if (avgEl.TryGetProperty(opt, out var optEl))
                    foreach (var (name, _) in md.Criteria)
                        if (optEl.TryGetProperty(name, out var sv))
                            md.AverageScores[opt][name] = sv.GetDouble();

                if (wsEl.TryGetProperty(opt, out var wsv))
                    md.WeightedScores[opt] = wsv.GetDouble();
            }

            if (md.Ranking.Count > 0) _matrix = md;
        }
        catch { }
    }

    private class MatrixDisplay
    {
        public List<string> Ranking { get; set; } = new();
        public List<(string Name, double Weight)> Criteria { get; set; } = new();
        public Dictionary<string, Dictionary<string, double>> AverageScores { get; set; } = new();
        public Dictionary<string, double> WeightedScores { get; set; } = new();
    }

    private class MemberForm
    {
        public string Name { get; set; } = string.Empty;
        public int Role { get; set; } = 1;
        public bool IsAi { get; set; } = true;
        public string? SystemPromptOverride { get; set; }
    }

    // Neutral midpoint score used when session data doesn't supply a value
    private const double DefaultNeutralScore = 5.0;

    /// <summary>Derive which MCDA method slug to use based on the council's MethodType.</summary>
    private string McdaMethodSlug(int councilMethod) => councilMethod switch
    {
        7 => "ahp",
        8 => "electre",
        9 => "topsis",
        10 => "promethee",
        11 => "grey-theory",
        _ => "topsis"   // WeightedDeliberation and others default to TOPSIS
    };

    private void RefreshMcdaBridge()
    {
        _mcdaBridge = null;
        _mcdaResult = null;
        if (_council is null || _session is null) return;
        if (string.IsNullOrEmpty(_session.StatePayload) || _session.StatePayload == "{}") return;

        // Only show MCDA bridge for methods that produce a scoring matrix (6-11)
        if (_council.SelectedMethod < 6) return;

        try
        {
            using var doc = JsonDocument.Parse(_session.StatePayload);
            var root = doc.RootElement;

            // Extract top-level options & criteria
            if (!root.TryGetProperty("options", out var optEl) || optEl.ValueKind != JsonValueKind.Array) return;
            if (!root.TryGetProperty("criteria", out var critEl) || critEl.ValueKind != JsonValueKind.Array) return;

            var options = optEl.EnumerateArray()
                .Select(e => e.GetString() ?? "").Where(s => s.Length > 0).ToList();
            if (options.Count == 0) return;

            var criteria = critEl.EnumerateArray().Select(c =>
            {
                var name = c.TryGetProperty("name", out var n) ? n.GetString() ?? "" : "";
                var weight = c.TryGetProperty("weight", out var w) ? w.GetDouble() : 1.0;
                var isBenefit = !c.TryGetProperty("isBenefit", out var ib) || ib.GetBoolean(); // default true (benefit) when property absent
                return new McdaCriterionModel { Name = name, Weight = weight, IsBenefit = isBenefit };
            }).Where(c => c.Name.Length > 0).ToList();
            if (criteria.Count == 0) return;

            // Extract average scores: try "result.averageScores" (MCDA methods), fallback to "matrix.averageScores" (WeightedDeliberation)
            JsonElement avgEl = default;
            bool hasAvg = false;
            if (root.TryGetProperty("result", out var resultEl) && resultEl.ValueKind == JsonValueKind.Object
                && resultEl.TryGetProperty("averageScores", out avgEl))
            {
                hasAvg = true;
            }
            else if (root.TryGetProperty("matrix", out var matrixEl2) && matrixEl2.ValueKind == JsonValueKind.Object
                     && matrixEl2.TryGetProperty("averageScores", out avgEl))
            {
                hasAvg = true;
            }

            var scores = new Dictionary<string, Dictionary<string, double>>();
            foreach (var opt in options)
            {
                scores[opt] = new();
                if (hasAvg && avgEl.TryGetProperty(opt, out var optScores))
                    foreach (var c in criteria)
                        if (optScores.TryGetProperty(c.Name, out var sv))
                            scores[opt][c.Name] = sv.GetDouble();
                // Fill missing scores with a neutral default
                foreach (var c in criteria)
                    if (!scores[opt].ContainsKey(c.Name))
                        scores[opt][c.Name] = DefaultNeutralScore;
            }

            _mcdaBridge = new McdaBridgeState
            {
                McdaMethod = McdaMethodSlug(_council.SelectedMethod),
                Options = options,
                Criteria = criteria,
                Scores = scores
            };
        }
        catch { }
    }

    private void SetMcdaMethod(string? val)
    {
        if (_mcdaBridge is null || val is null) return;
        _mcdaBridge.McdaMethod = val;
    }

    private void SetMcdaCriterionWeight(int idx, string? raw)
    {
        if (_mcdaBridge is null) return;
        if (double.TryParse(raw, System.Globalization.NumberStyles.Any,
                            System.Globalization.CultureInfo.InvariantCulture, out var w))
            _mcdaBridge.Criteria[idx].Weight = w;
    }

    private double GetBridgeScore(string opt, string crit)
    {
        if (_mcdaBridge?.Scores.TryGetValue(opt, out var row) == true && row.TryGetValue(crit, out var v))
            return v;
        return DefaultNeutralScore;
    }

    private void SetBridgeScore(string opt, string crit, string? raw)
    {
        if (_mcdaBridge is null) return;
        if (!double.TryParse(raw, System.Globalization.NumberStyles.Any,
                             System.Globalization.CultureInfo.InvariantCulture, out var v)) return;
        if (!_mcdaBridge.Scores.ContainsKey(opt))
            _mcdaBridge.Scores[opt] = new();
        _mcdaBridge.Scores[opt][crit] = v;
    }

    private async Task RunMcda()
    {
        if (_mcdaBridge is null) return;
        _mcdaError = null;
        _mcdaResult = null;

        var input = new McdaInputModel
        {
            Options = _mcdaBridge.Options.ToList(),
            Criteria = _mcdaBridge.Criteria.Select(c => new McdaCriterionModel
            {
                Name = c.Name,
                Weight = c.Weight,
                IsBenefit = c.IsBenefit
            }).ToList(),
            Scores = _mcdaBridge.Options.ToDictionary(
                o => o,
                o => _mcdaBridge.Criteria.ToDictionary(
                    c => c.Name,
                    c => GetBridgeScore(o, c.Name)))
        };

        _mcdaRunning = true;
        try
        {
            _mcdaResult = await Api.RunMcdaAsync(_mcdaBridge.McdaMethod, input);
        }
        catch (Exception ex)
        {
            _mcdaError = $"MCDA error: {ex.Message}";
        }
        finally
        {
            _mcdaRunning = false;
        }
    }

    private class McdaBridgeState
    {
        public string McdaMethod { get; set; } = "topsis";
        public List<string> Options { get; set; } = new();
        public List<McdaCriterionModel> Criteria { get; set; } = new();
        public Dictionary<string, Dictionary<string, double>> Scores { get; set; } = new();
    }
}
